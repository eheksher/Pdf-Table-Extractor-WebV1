// pdf-extractor_2.js - ×’×¨×¡×” ×¤×©×•×˜×”: ×©×œ×™×¤×ª ×˜×§×¡×˜ + ×›×¤×™×œ×•×ª + ×—×™×¤×•×© + ×¡×™××•×Ÿ + ×¡×™× ×•×Ÿ

console.log('ğŸ”§ ×˜×•×¢×Ÿ ×ª×•×¡×¤×ª ×¤×©×•×˜×”...');

// *** ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×¤×©×•×˜×™× ***
var extractedTexts = []; // ×›×œ ×”×˜×§×¡×˜×™× ×©× ××¦××•
var isExtracting = false;
var searchResults = []; // ×ª×•×¦××•×ª ×—×™×¤×•×©
var duplicateResults = []; // ×ª×•×¦××•×ª ×›×¤×™×œ×•×ª
var isSimpleSearchMode = false;
var isSimpleDuplicateMode = false;

// *** ××©×ª× ×™× ×—×“×©×™× ×œ×¡×™×•×•×’ ***
var classificationSettings = []; // ×”×’×“×¨×•×ª ×”×¡×™×•×•×’×™× ×©×”××©×ª××© ×”×’×“×™×¨
var currentClassificationMode = null; // ×”×¡×™×•×•×’ ×”× ×•×›×—×™ ×©×¤×•×¢×œ
var isClassificationMode = false;

// *** ×”××ª× ×” ×œ×˜×¢×™× ×ª ×”×§×•×‘×¥ ×”×¨××©×™ ***
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    if (typeof window.files !== 'undefined') {
      initSimpleFeatures();
    } else {
      setTimeout(arguments.callee, 500);
    }
  }, 1000);
});

// *** ×”×’×“×¨×ª ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª ××™×“ ***
window.showClassificationPopup = showClassificationPopup;
window.closeClassificationPopup = closeClassificationPopup;
window.addClassification = addClassification;
window.deleteClassification = deleteClassification;
window.applyClassification = applyClassification;
window.addClassificationColumnManually = addClassificationColumnManually;
window.runAutoClassification = runAutoClassification;

// *** ×¤×•× ×§×¦×™×” ×™×“× ×™×ª ×œ×”×•×¡×¤×ª ×¢××•×“×ª ×¡×™×•×•×’ ***
function addClassificationColumnManually() {
  console.log('ğŸ”§ ××•×¡×™×£ ×¢××•×“×ª ×¡×™×•×•×’ ×‘××•×¤×Ÿ ×™×“× ×™...');
  
  const classificationColumn = '×¡×™×•×•×’';
  
  // ×‘×“×™×§×” ×× ×”××¢×¨×›×ª ××•×›× ×”
  if (typeof window.customHeaders === 'undefined') {
    showSimpleToast('×”××¢×¨×›×ª ×¢×“×™×™×Ÿ ×œ× × ×˜×¢× ×” - × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢');
    return;
  }
  
  // ×‘×“×™×§×” ×× ×”×¢××•×“×” ×›×‘×¨ ×§×™×™××ª
  if (window.customHeaders.indexOf(classificationColumn) !== -1) {
    showSimpleToast('×¢××•×“×ª ×¡×™×•×•×’ ×›×‘×¨ ×§×™×™××ª!');
    return;
  }
  
  // ×”×•×¡×¤×ª ×”×¢××•×“×”
  window.customHeaders.push(classificationColumn);
  
  if (typeof window.visibleHeaders !== 'undefined') {
    window.visibleHeaders.push(classificationColumn);
  }
  
  // ×”×•×¡×¤×” ×œ×›×œ ×”×©×•×¨×•×ª ×”×§×™×™××•×ª
  if (typeof window.data !== 'undefined' && window.data.length > 0) {
    window.data.forEach(function(row) {
      row[classificationColumn] = '';
    });
    console.log(`âœ… ×¢××•×“×ª ×¡×™×•×•×’ × ×•×¡×¤×” ×œ-${window.data.length} ×©×•×¨×•×ª`);
  }
  
  // ×©××™×¨×” ×•×¢×“×›×•×Ÿ
  if (typeof window.saveDataToStorage === 'function') {
    window.saveDataToStorage();
  }
  
  if (typeof window.renderTable === 'function') {
    window.renderTable();
  }
  
  showSimpleToast('×¢××•×“×ª ×¡×™×•×•×’ × ×•×¡×¤×” ×‘×”×¦×œ×—×”!');
  console.log('âœ… ×¢××•×“×ª ×¡×™×•×•×’ × ×•×¡×¤×” ×™×“× ×™×ª');
}

// *** ×¤×•× ×§×¦×™×” ×œ×¡×™×•×•×’ ××•×˜×•××˜×™ ×©×œ ×›×œ ×”×§×‘×¦×™× ***
// ×ª×™×§×•×Ÿ ×¤×•× ×§×¦×™×™×ª ×”×¡×™×•×•×’ ×”××•×˜×•××˜×™ ×¢× ×“×™×‘×•×’ ××¤×•×¨×˜

function runAutoClassification() {
  console.log('××ª×—×™×œ ×¡×™×•×•×’ ××•×˜×•××˜×™...');
  
  // *** ×‘×“×™×§×•×ª ×¨××©×•× ×™×•×ª ××¤×•×¨×˜×•×ª ***
  
  // ×‘×“×™×§×” 1: ×”×× ×™×© ×˜×§×¡×˜×™× ×©× ×©×œ×¤×•
  if (!extractedTexts || extractedTexts.length === 0) {
    alert('âŒ ×œ× × ××¦××• ×˜×§×¡×˜×™×! ×× × ×”×¨×¥ "×©×œ×•×£ ×˜×§×¡×˜×™×" ×ª×—×™×œ×”');
    console.error('extractedTexts ×¨×™×§ ××• ×œ× ×§×™×™×:', extractedTexts);
    return;
  }
  console.log(`âœ… × ××¦××• ${extractedTexts.length} ×˜×§×¡×˜×™×`);
  
  // ×‘×“×™×§×” 2: ×”×× ×™×© ×¡×™×•×•×’×™× ××•×’×“×¨×™×
  if (!classificationSettings || classificationSettings.length === 0) {
    alert('âŒ ×œ× ×”×•×’×“×¨×• ×¡×™×•×•×’×™×! ×× × ×”×’×“×¨ ×¡×™×•×•×’×™× ×‘"× ×™×”×•×œ ×¡×™×•×•×’×™×" ×ª×—×™×œ×”');
    console.error('classificationSettings ×¨×™×§ ××• ×œ× ×§×™×™×:', classificationSettings);
    return;
  }
  console.log(`âœ… × ××¦××• ${classificationSettings.length} ×¡×™×•×•×’×™×:`, classificationSettings);
  
  // ×‘×“×™×§×” 3: ×”×× ×™×© × ×ª×•× ×™×
  if (!window.data || window.data.length === 0) {
    alert('âŒ ×œ× × ××¦××• ×§×‘×¦×™×! ×× × ×˜×¢×Ÿ ×§×‘×¦×™ PDF ×ª×—×™×œ×”');
    console.error('window.data ×¨×™×§ ××• ×œ× ×§×™×™×:', window.data);
    return;
  }
  console.log(`âœ… × ××¦××• ${window.data.length} ×§×‘×¦×™× ×‘××¢×¨×›×ª`);
  
  // ×‘×“×™×§×” 4: ×•×™×“×•× ×©×¢××•×“×ª ×”×¡×™×•×•×’ ×§×™×™××ª
  const hasClassificationColumn = window.data[0] && window.data[0].hasOwnProperty('×¡×™×•×•×’');
  if (!hasClassificationColumn) {
    console.log('âš ï¸ ×¢××•×“×ª ×¡×™×•×•×’ ×œ× ×§×™×™××ª - ××•×¡×™×£ ××•×ª×”...');
    addClassificationColumnManually();
    
    // ×‘×“×™×§×” ×× ×”×”×•×¡×¤×” ×”×¦×œ×™×—×”
    if (!window.data[0] || !window.data[0].hasOwnProperty('×¡×™×•×•×’')) {
      alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¢××•×“×ª ×”×¡×™×•×•×’!');
      return;
    }
  }
  console.log('âœ… ×¢××•×“×ª ×¡×™×•×•×’ ×§×™×™××ª');
  
  // *** ×”×ª×—×œ×ª ×ª×”×œ×™×š ×”×¡×™×•×•×’ ***
  
  let classifiedCount = 0;
  let debugResults = [];
  
  // ×¢×‘×•×¨ ×¢×œ ×›×œ ×§×•×‘×¥
  window.data.forEach(function(fileData, fileIndex) {
    const fileName = fileData['×©× ×§×•×‘×¥'] || fileData['fileName'] || `×§×•×‘×¥ ${fileIndex + 1}`;
    
    console.log(`\nğŸ” ××¢×‘×“ ×§×•×‘×¥ ${fileIndex + 1}: ${fileName}`);
    
    // ×§×‘×œ ××ª ×›×œ ×”×˜×§×¡×˜×™× ×©×œ ×”×§×•×‘×¥ ×”×–×”
    const fileTexts = extractedTexts.filter(t => t.fileIndex === fileIndex);
    
    if (fileTexts.length === 0) {
      console.log(`âš ï¸ ×œ× × ××¦××• ×˜×§×¡×˜×™× ×¢×‘×•×¨ ×§×•×‘×¥ ${fileName}`);
      debugResults.push({
        fileName: fileName,
        status: '××™×Ÿ ×˜×§×¡×˜×™×',
        classification: ''
      });
      return;
    }
    
    // ×¦×¨×£ ××ª ×›×œ ×”×˜×§×¡×˜×™× ×œ×˜×§×¡×˜ ××—×“
    const allText = fileTexts.map(t => t.text).join(' ').toLowerCase();
    console.log(`ğŸ“ ×˜×§×¡×˜ ××”×§×•×‘×¥ (100 ×ª×•×•×™× ×¨××©×•× ×™×): "${allText.substring(0, 100)}..."`);
    
    // ×—×¤×© ××ª ×”×¡×™×•×•×’ ×”×˜×•×‘ ×‘×™×•×ª×¨
    let bestClassification = '';
    let maxMatches = 0;
    let detailedMatches = [];
    
    classificationSettings.forEach(function(classification) {
      let matches = 0;
      let foundTerms = [];
      
      classification.terms.forEach(function(term) {
        // ×¡×¤×•×¨ ×›××” ×¤×¢××™× ×”××™×œ×” ××•×¤×™×¢×”
        const regex = new RegExp(term.toLowerCase(), 'g');
        const termMatches = (allText.match(regex) || []).length;
        
        if (termMatches > 0) {
          matches += termMatches;
          foundTerms.push(`${term}(${termMatches})`);
        }
      });
      
      detailedMatches.push({
        classification: classification.name,
        matches: matches,
        foundTerms: foundTerms
      });
      
      console.log(`   ğŸ·ï¸ ×¡×™×•×•×’ "${classification.name}": ${matches} ×”×ª×××•×ª [${foundTerms.join(', ')}]`);
      
      // ×× ×™×© ×™×•×ª×¨ ×”×ª×××•×ª ××”×¡×™×•×•×’ ×”× ×•×›×—×™
      if (matches > maxMatches && matches > 0) {
        maxMatches = matches;
        bestClassification = classification.name;
      }
    });
    
    // ×¢×“×›×Ÿ ××ª ×”×¡×™×•×•×’ ×‘×˜×‘×œ×”
    if (bestClassification) {
      fileData['×¡×™×•×•×’'] = bestClassification;
      classifiedCount++;
      console.log(`âœ… ×§×•×‘×¥ "${fileName}" ×¡×•×•×’ ×›: "${bestClassification}" ×¢× ${maxMatches} ×”×ª×××•×ª`);
      
      debugResults.push({
        fileName: fileName,
        status: '×¡×•×•×’ ×‘×”×¦×œ×—×”',
        classification: bestClassification,
        matches: maxMatches,
        details: detailedMatches
      });
    } else {
      console.log(`âŒ ×œ× × ××¦× ×¡×™×•×•×’ ××ª××™× ×¢×‘×•×¨ "${fileName}"`);
      fileData['×¡×™×•×•×’'] = ''; // ×”×©××¨ ×¨×™×§
      
      debugResults.push({
        fileName: fileName,
        status: '×œ× × ××¦× ×¡×™×•×•×’',
        classification: '',
        details: detailedMatches
      });
    }
  });
  
  // *** ×¡×™×•× ×”×ª×”×œ×™×š ***
  
  console.log('\nğŸ“Š ×¡×™×›×•× ×ª×”×œ×™×š ×”×¡×™×•×•×’:');
  console.log('×ª×•×¦××•×ª ××¤×•×¨×˜×•×ª:', debugResults);
  
  // ×©××•×¨ ××ª ×”×©×™× ×•×™×™×
  if (typeof window.saveDataToStorage === 'function') {
    console.log('ğŸ’¾ ×©×•××¨ × ×ª×•× ×™×...');
    window.saveDataToStorage();
  }
  
  // ×¢×“×›×Ÿ ××ª ×”×˜×‘×œ×”
  if (typeof window.renderTable === 'function') {
    console.log('ğŸ”„ ××¢×“×›×Ÿ ×˜×‘×œ×”...');
    window.renderTable();
  }
  
  // ×”×•×“×¢×ª ×¡×™×›×•×
  const message = `ğŸ¯ ×¡×™×•×•×’ ××•×˜×•××˜×™ ×”×•×©×œ×!\nâœ… ${classifiedCount} ×§×‘×¦×™× ×¡×•×•×’×• ×‘×”×¦×œ×—×”\nğŸ“ ××ª×•×š ${window.data.length} ×§×‘×¦×™× ×›×•×œ×œ`;
  alert(message);
  
  console.log(`ğŸ¯ ×¡×™×•×: ${classifiedCount}/${window.data.length} ×§×‘×¦×™× ×¡×•×•×’×•`);
  
  // ×”×—×–×¨ ×ª×•×¦××•×ª ×œ×“×™×‘×•×’
  return {
    total: window.data.length,
    classified: classifiedCount,
    details: debugResults
  };
}

// *** ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ××©×•×¤×¨×ª ×œ×”×•×¡×¤×ª ×¢××•×“×ª ×¡×™×•×•×’ ***
function addClassificationColumnManually() {
  console.log('ğŸ”§ ××•×¡×™×£ ×¢××•×“×ª ×¡×™×•×•×’ ×‘××•×¤×Ÿ ×™×“× ×™...');
  
  const classificationColumn = '×¡×™×•×•×’';
  
  // ×‘×“×™×§×•×ª ×‘×˜×™×—×•×ª
  if (typeof window.data === 'undefined' || !window.data) {
    console.error('âŒ window.data ×œ× ×§×™×™×');
    alert('âŒ ×©×’×™××”: ×œ× × ××¦××• × ×ª×•× ×™× ×‘××¢×¨×›×ª');
    return false;
  }
  
  if (window.data.length === 0) {
    console.error('âŒ window.data ×¨×™×§');
    alert('âŒ ×©×’×™××”: ××™×Ÿ ×§×‘×¦×™× ×‘××¢×¨×›×ª');
    return false;
  }
  
  // ×‘×“×™×§×” ×× ×”×¢××•×“×” ×›×‘×¨ ×§×™×™××ª
  if (window.data[0] && window.data[0].hasOwnProperty(classificationColumn)) {
    console.log('âœ… ×¢××•×“×ª ×¡×™×•×•×’ ×›×‘×¨ ×§×™×™××ª');
    return true;
  }
  
  // ×”×•×¡×¤×ª ×¢××•×“×” ×œ×›×œ ×”×©×•×¨×•×ª
  window.data.forEach(function(row) {
    row[classificationColumn] = '';
  });
  
  // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×¢××•×“×•×ª ×× ×§×™×™××ª
  if (typeof window.customHeaders !== 'undefined' && Array.isArray(window.customHeaders)) {
    if (window.customHeaders.indexOf(classificationColumn) === -1) {
      window.customHeaders.push(classificationColumn);
      console.log('âœ… ×¢××•×“×” × ×•×¡×¤×” ×œ-customHeaders');
    }
  }
  
  if (typeof window.visibleHeaders !== 'undefined' && Array.isArray(window.visibleHeaders)) {
    if (window.visibleHeaders.indexOf(classificationColumn) === -1) {
      window.visibleHeaders.push(classificationColumn);
      console.log('âœ… ×¢××•×“×” × ×•×¡×¤×” ×œ-visibleHeaders');
    }
  }
  
  console.log(`âœ… ×¢××•×“×ª "${classificationColumn}" × ×•×¡×¤×” ×œ-${window.data.length} ×©×•×¨×•×ª`);
  
  // ×©××™×¨×” ×•×¢×“×›×•×Ÿ
  if (typeof window.saveDataToStorage === 'function') {
    window.saveDataToStorage();
  }
  
  if (typeof window.renderTable === 'function') {
    window.renderTable();
  }
  
  return true;
}

// ×¢×“×›×•×Ÿ ×”×¤×•× ×§×¦×™×•×ª ×”×’×œ×•×‘×œ×™×•×ª
window.runAutoClassification = runAutoClassification;
window.addClassificationColumnManually = addClassificationColumnManually;

console.log('ğŸ”§ ×¤×•× ×§×¦×™×•×ª ×¡×™×•×•×’ ××•×˜×•××˜×™ ×¢×•×“×›× ×• ×¢× ×“×™×‘×•×’ ××¤×•×¨×˜');
function initSimpleFeatures() {
  addSimpleButtons();
  console.log('âœ… ×ª×•×¡×¤×ª ×¤×©×•×˜×” ×¤×¢×™×œ×”');
}

// *** ×”×•×¡×¤×ª ×›×¤×ª×•×¨×™× ×¤×©×•×˜×™× - ×¨×§ ×× ×œ× ×§×™×™××™× ***
function addSimpleButtons() {
  const analysisTab = document.getElementById('analysis-tab');
  if (!analysisTab) return;
  
  // ×‘×“×™×§×” ×× ×”×›×¤×ª×•×¨×™× ×›×‘×¨ ×§×™×™××™× ×‘-HTML
  if (document.getElementById('simpleDuplicateBtn')) {
    console.log('âœ… ×›×¤×ª×•×¨×™× ×›×‘×¨ ×§×™×™××™× ×‘-HTML - ×œ× ××•×¡×™×£ ×›×¤×™×œ×•×™×•×ª');
    
    // ××‘×œ ×¢×“×™×™×Ÿ ×¦×¨×™×š ×œ×”×•×¡×™×£ ××ª ×”×¡×˜×™×™×œ×™×
    addSimpleStyles();
    return; // ××œ ×ª×•×¡×™×£ ×›×¤×ª×•×¨×™× ×× ×”× ×›×‘×¨ ×§×™×™××™×
  }
  
  console.log('âš ï¸ ×›×¤×ª×•×¨×™× ×œ× × ××¦××• ×‘-HTML - ××•×¡×™×£ ×“×™× ××™×ª');
  
  // ×›×¤×ª×•×¨ ×©×œ×™×¤×ª ×˜×§×¡×˜×™×
  const extractGroup = document.createElement('div');
  extractGroup.className = 'button-group';
  extractGroup.innerHTML = `
    <button class="office-btn simple-feature" onclick="extractAllTexts()" 
            title="×©×œ×•×£ ××ª ×›×œ ×”×˜×§×¡×˜×™× ××”×§×‘×¦×™× ×¢× ××™×§×•×">
      <div class="btn-text">ğŸ“„<br>×©×œ×•×£ ×˜×§×¡×˜×™×</div>
    </button>
  `;
  
  // ×›×¤×ª×•×¨ ×›×¤×™×œ×•×ª ×¤×©×•×˜
  const duplicateGroup = document.createElement('div');
  duplicateGroup.className = 'button-group';
  duplicateGroup.innerHTML = `
    <button class="office-btn simple-feature" onclick="findTextDuplicates()" id="simpleDuplicateBtn"
            title="××¦× ×§×‘×¦×™× ×¢× ×˜×§×¡×˜×™× ×–×”×™× ×•×¡××Ÿ ××•×ª×">
      <div class="btn-text">ğŸ‘¥<br>×›×¤×™×œ×•×ª ×˜×§×¡×˜</div>
    </button>
  `;
  
  // ×›×¤×ª×•×¨ ×—×™×¤×•×© ×¤×©×•×˜
  const searchGroup = document.createElement('div');
  searchGroup.className = 'button-group';
  searchGroup.innerHTML = `
    <input type="text" id="simpleSearchInput" placeholder="×—×¤×© ×˜×§×¡×˜..." 
           style="width: 120px; margin-bottom: 5px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
           onkeypress="if(event.key==='Enter') searchTexts()">
    <button class="office-btn simple-feature" onclick="searchTexts()" id="simpleSearchBtn"
            title="×—×¤×© ×˜×§×¡×˜ ×‘×›×œ ×”×§×‘×¦×™× ×•×¡××Ÿ ×ª×•×¦××•×ª">
      <div class="btn-text">ğŸ”<br>×—×¤×© ×˜×§×¡×˜</div>
    </button>
  `;
  
  // ×›×¤×ª×•×¨ × ×™×”×•×œ ×¡×™×•×•×’×™×
  const classificationGroup = document.createElement('div');
  classificationGroup.className = 'button-group';
  classificationGroup.innerHTML = `
    <button class="office-btn classification-feature" onclick="showClassificationPopup()" 
            title="×”×’×“×¨ ×¡×™×•×•×’×™× ××•×ª×××™× ××™×©×™×ª ×œ×—×™×¤×•×©×™×">
      <div class="btn-text">ğŸ·ï¸<br>× ×™×”×•×œ ×¡×™×•×•×’×™×</div>
    </button>
  `;
  
  // ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×¢××•×“×ª ×¡×™×•×•×’
  const addColumnGroup = document.createElement('div');
  addColumnGroup.className = 'button-group';
  addColumnGroup.innerHTML = `
    <button class="office-btn" onclick="addClassificationColumnManually()" 
            style="background: linear-gradient(135deg, #17a2b8, #138496) !important; color: white !important;"
            title="×”×•×¡×£ ×¢××•×“×ª ×¡×™×•×•×’ ×œ×˜×‘×œ×” ×× ×”×™× ×œ× ×§×™×™××ª">
      <div class="btn-text">â•<br>×”×•×¡×£ ×¢××•×“×ª ×¡×™×•×•×’</div>
    </button>
  `;
  
  // ×›×¤×ª×•×¨ ×¡×™×•×•×’ ××•×˜×•××˜×™
  const autoClassifyGroup = document.createElement('div');
  autoClassifyGroup.className = 'button-group';
  autoClassifyGroup.innerHTML = `
    <button class="office-btn" onclick="runAutoClassification()" 
            style="background: linear-gradient(135deg, #28a745, #20c997) !important; color: white !important;"
            title="×¡×•×•×’ ××•×˜×•××˜×™×ª ××ª ×›×œ ×”×§×‘×¦×™× ×œ×¤×™ ×”×¡×™×•×•×’×™× ×©×”×•×’×“×¨×•">
      <div class="btn-text">ğŸ¤–<br>×¡×™×•×•×’ ××•×˜×•××˜×™</div>
    </button>
  `;
  
  // ×›×¤×ª×•×¨ × ×™×§×•×™ ×¡×™× ×•× ×™×
  const clearGroup = document.createElement('div');
  clearGroup.className = 'button-group';
  clearGroup.innerHTML = `
    <button class="office-btn simple-clear" onclick="clearSimpleFilters()" 
            title="× ×§×” ××ª ×›×œ ×”×¡×™× ×•× ×™× ×•×—×–×•×¨ ×œ×ª×¦×•×’×” ×¨×’×™×œ×”">
      <div class="btn-text">ğŸ—‘ï¸<br>× ×§×” ×¡×™× ×•× ×™×</div>
    </button>
  `;
  
  // ××•× ×” ×ª×•×¦××•×ª
  const counterGroup = document.createElement('div');
  counterGroup.className = 'button-group';
  counterGroup.innerHTML = `
    <div class="simple-counter" title="××¡×¤×¨ ×§×‘×¦×™× ×©× ××¦××• ×‘×¡×™× ×•×Ÿ ×”× ×•×›×—×™">
      <div class="counter-label">×ª×•×¦××•×ª</div>
      <div class="counter-value" id="simpleResultsCount">0</div>
    </div>
  `;
  
  analysisTab.appendChild(extractGroup);
  analysisTab.appendChild(duplicateGroup);  
  analysisTab.appendChild(searchGroup);
  analysisTab.appendChild(classificationGroup);
  analysisTab.appendChild(addColumnGroup);
  analysisTab.appendChild(autoClassifyGroup);
  analysisTab.appendChild(clearGroup);
  analysisTab.appendChild(counterGroup);
  
  // ×¡×˜×™×™×œ×™× ×¤×©×•×˜×™×
  addSimpleStyles();
}

// *** ×©×œ×™×¤×ª ×›×œ ×”×˜×§×¡×˜×™× ***
function extractAllTexts() {
  if (isExtracting) {
    showSimpleToast('×©×œ×™×¤×” ×›×‘×¨ ×¤×•×¢×œ×ª...');
    return;
  }
  
  if (!window.files || window.files.length === 0) {
    showSimpleToast('×× × ×˜×¢×Ÿ ×§×‘×¦×™ PDF ×ª×—×™×œ×”');
    return;
  }
  
  isExtracting = true;
  extractedTexts = [];
  
  showSimpleToast('××ª×—×™×œ ×œ×©×œ×•×£ ×˜×§×¡×˜×™×...');
  
  extractFromAllFiles()
    .then(function(totalTexts) {
      isExtracting = false;
      showSimpleToast(`×©×œ×™×¤×” ×”×•×©×œ××”! × ××¦××• ${totalTexts} ×˜×§×¡×˜×™×`);
      console.log('ğŸ“„ ×›×œ ×”×˜×§×¡×˜×™×:', extractedTexts);
    })
    .catch(function(error) {
      isExtracting = false;
      console.error('×©×’×™××” ×‘×©×œ×™×¤×”:', error);
      showSimpleToast('×©×’×™××” ×‘×©×œ×™×¤×ª ×”×˜×§×¡×˜×™×');
    });
}

// *** ×©×œ×™×¤×” ××›×œ ×”×§×‘×¦×™× ***
function extractFromAllFiles() {
  const promises = [];
  
  for (let i = 0; i < window.files.length; i++) {
    promises.push(extractFromFile(window.files[i], i));
  }
  
  return Promise.all(promises)
    .then(function(results) {
      let total = 0;
      results.forEach(function(fileTexts) {
        extractedTexts = extractedTexts.concat(fileTexts);
        total += fileTexts.length;
      });
      return total;
    });
}

// *** ×©×œ×™×¤×” ××§×•×‘×¥ ×™×—×™×“ ***
function extractFromFile(file, fileIndex) {
  return file.arrayBuffer()
    .then(function(buffer) {
      const loadingTask = pdfjsLib.getDocument({
        data: buffer,
        cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/',
        cMapPacked: true
      });
      return loadingTask.promise;
    })
    .then(function(pdf) {
      return extractFromPdf(pdf, file.name, fileIndex);
    });
}

// *** ×©×œ×™×¤×” ×-PDF ***
function extractFromPdf(pdf, fileName, fileIndex) {
  const pagePromises = [];
  
  // ××•×’×‘×œ ×œ-5 ×¢××•×“×™× ×¨××©×•× ×™× ×œ×‘×™×¦×•×¢×™×
  for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 5); pageNum++) {
    pagePromises.push(extractFromPage(pdf, pageNum, fileName, fileIndex));
  }
  
  return Promise.all(pagePromises)
    .then(function(allPages) {
      const allTexts = [];
      allPages.forEach(function(pageTexts) {
        allTexts.push(...pageTexts);
      });
      return allTexts;
    });
}

// *** ×©×œ×™×¤×” ××¢××•×“ ***
function extractFromPage(pdf, pageNum, fileName, fileIndex) {
  return pdf.getPage(pageNum)
    .then(function(page) {
      return page.getTextContent();
    })
    .then(function(textContent) {
      const pageTexts = [];
      
      if (textContent.items) {
        textContent.items.forEach(function(item) {
          if (item.str && item.str.trim()) {
            pageTexts.push({
              fileName: fileName,
              fileIndex: fileIndex,
              page: pageNum,
              text: item.str.trim(),
              x: Math.round(item.transform[4]),
              y: Math.round(item.transform[5]),
              width: Math.round(item.width),
              height: Math.round(item.height)
            });
          }
        });
      }
      
      return pageTexts;
    });
}

// *** ×—×™×¤×•×© ×›×¤×™×œ×•×ª ×˜×§×¡×˜ ××ª×§×“× ***
function findTextDuplicates() {
  if (extractedTexts.length === 0) {
    showSimpleToast('×”×¨×¥ ×©×œ×™×¤×ª ×˜×§×¡×˜×™× ×ª×—×™×œ×”');
    return;
  }
  
  duplicateResults = [];
  isSimpleDuplicateMode = true;
  isSimpleSearchMode = false;
  
  // ×ª××™×“ ×”×©×•×•××” ×¢×œ ×‘×¡×™×¡ ×”×˜×§×¡×˜ ×©× ×©×œ×£ ××”-PDF
  findDuplicatesByExtractedText();
  
  // ×¢×“×›×•×Ÿ ×‘×—×™×¨×” ×•×˜×‘×œ×”
  updateSimpleSelection(duplicateResults);
  setActiveSimpleButton('simpleDuplicateBtn');
  
  if (duplicateResults.length > 0) {
    showSimpleToast(`× ××¦××• ${duplicateResults.length} ×§×‘×¦×™× ×›×¤×•×œ×™×`);
  } else {
    showSimpleToast('×œ× × ××¦××• ×§×‘×¦×™× ×›×¤×•×œ×™×');
  }
}

// *** ×”×©×•×•××” ×¢×œ ×‘×¡×™×¡ ×”×˜×§×¡×˜ ×©× ×©×œ×£ ××”-PDF ***
function findDuplicatesByExtractedText() {
  // ×§×™×‘×•×¥ ×˜×§×¡×˜×™× ×œ×¤×™ ×§×•×‘×¥
  const fileTextMap = {};
  
  extractedTexts.forEach(function(textItem) {
    if (!fileTextMap[textItem.fileIndex]) {
      fileTextMap[textItem.fileIndex] = {
        fileName: textItem.fileName,
        allTexts: [],
        significantTexts: []
      };
    }
    
    const cleanText = textItem.text.toLowerCase().trim();
    fileTextMap[textItem.fileIndex].allTexts.push(cleanText);
    
    // ×¨×§ ×˜×§×¡×˜×™× ××©××¢×•×ª×™×™× ×œ×—×™×©×•×‘ ×”×“××™×•×Ÿ
    if (isSignificantText(cleanText)) {
      fileTextMap[textItem.fileIndex].significantTexts.push(cleanText);
    }
  });
  
  const fileIndexes = Object.keys(fileTextMap).map(Number);
  
  // ×”×©×•×•××” ×‘×™×Ÿ ×›×œ ×–×•×’ ×§×‘×¦×™×
  for (let i = 0; i < fileIndexes.length; i++) {
    for (let j = i + 1; j < fileIndexes.length; j++) {
      const file1Index = fileIndexes[i];
      const file2Index = fileIndexes[j];
      
      const file1Data = fileTextMap[file1Index];
      const file2Data = fileTextMap[file2Index];
      
      // ×—×™×©×•×‘ ×“××™×•×Ÿ ×¢×œ ×‘×¡×™×¡ ×”×˜×§×¡×˜ ×©× ×©×œ×£
      const similarity = calculateExtractedTextSimilarity(file1Data, file2Data);
      
      console.log(`×”×©×•×•××ª ×˜×§×¡×˜: ${file1Data.fileName} âŸ· ${file2Data.fileName}: ${(similarity * 100).toFixed(1)}%`);
      
      // × ×—×©×‘ ×›×¤×•×œ ×¨×§ ×× ×™×© ×“××™×•×Ÿ ×©×œ 100% (××• ×§×¨×•×‘ ×××•×“)
      if (similarity >= 0.98) { // 98% ×›×“×™ ×œ××¤×©×¨ ×”×‘×“×œ×™× ×–×¢×™×¨×™× ×‘×¨×•×•×—×™×
        console.log(`âœ… ×›×¤×•×œ × ××¦×: ${file1Data.fileName} âŸ· ${file2Data.fileName} (${(similarity * 100).toFixed(1)}% ×“××™×•×Ÿ)`);
        
        if (!duplicateResults.includes(file1Index)) {
          duplicateResults.push(file1Index);
        }
        if (!duplicateResults.includes(file2Index)) {
          duplicateResults.push(file2Index);
        }
      }
    }
  }
}

// *** ×—×™×©×•×‘ ×“××™×•×Ÿ ×‘×™×Ÿ ×˜×§×¡×˜×™× ×©× ×©×œ×¤×• - ×“××™×•×Ÿ ××•×©×œ× ×‘×œ×‘×“ ***
function calculateExtractedTextSimilarity(file1Data, file2Data) {
  const sig1 = file1Data.significantTexts;
  const sig2 = file2Data.significantTexts;
  
  // ×‘×“×™×§×” ×©×™×© ××¡×¤×™×§ ×˜×§×¡×˜ ×œ×‘×“×™×§×”
  if (sig1.length < 5 || sig2.length < 5) {
    console.log(`×œ× ××¡×¤×™×§ ×˜×§×¡×˜ ××©××¢×•×ª×™: ${file1Data.fileName}(${sig1.length}) vs ${file2Data.fileName}(${sig2.length})`);
    return 0;
  }
  
  // ×‘×“×™×§×” ×©×™×© ××•×ª×” ×›××•×ª ×˜×§×¡×˜×™× (×‘×¢×¨×š)
  const lengthDiff = Math.abs(sig1.length - sig2.length);
  const maxLength = Math.max(sig1.length, sig2.length);
  if (lengthDiff > maxLength * 0.1) { // ×™×•×ª×¨ ×-10% ×”×‘×“×œ ×‘×›××•×ª ×”×˜×§×¡×˜×™×
    console.log(`×”×‘×“×œ ×’×“×•×œ ×‘×›××•×ª ×”×˜×§×¡×˜×™×: ${sig1.length} vs ${sig2.length}`);
    return 0;
  }
  
  // ×—×™×©×•×‘ ×”×ª×××•×ª ××“×•×™×§×•×ª ×‘×œ×‘×“ - ×œ×œ× ×”×ª×××•×ª ×—×œ×§×™×•×ª
  let exactMatches = 0;
  
  sig1.forEach(function(text1) {
    if (sig2.includes(text1)) {
      exactMatches++;
    }
  });
  
  // ×—×™×©×•×‘ ×”×“××™×•×Ÿ - ×¨×§ ×”×ª×××•×ª ××“×•×™×§×•×ª
  const similarity1 = exactMatches / sig1.length;
  const similarity2 = exactMatches / sig2.length;
  
  // ×”×“××™×•×Ÿ ×”×•× ×”×××•×¦×¢ ×©×œ ×©× ×™ ×”×›×™×•×•× ×™× (×›×“×™ ×œ×•×•×“× ×“××™×•×Ÿ ×“×•-×›×™×•×•× ×™)
  const finalSimilarity = (similarity1 + similarity2) / 2;
  
  console.log(`×¤×™×¨×•×˜ ×“××™×•×Ÿ ××“×•×™×§: ${exactMatches} ×”×ª×××•×ª ××ª×•×š ${sig1.length}/${sig2.length} ×˜×§×¡×˜×™× = ${(finalSimilarity * 100).toFixed(1)}%`);
  
  return finalSimilarity;
}

// *** ×‘×“×™×§×ª ×”×ª×××” ×—×œ×§×™×ª ×‘×™×Ÿ ×˜×§×¡×˜×™× ***
function isPartialTextMatch(text1, text2) {
  if (text1.length < 4 || text2.length < 4) return false;
  
  // ×× ××—×“ ××›×™×œ ××ª ×”×©× ×™ ×‘×¨×•×‘ ×”×ª×•×•×™×
  const minLength = Math.min(text1.length, text2.length);
  const maxLength = Math.max(text1.length, text2.length);
  
  if (minLength / maxLength < 0.6) return false; // ×¤×—×•×ª ×-60% ×—×¤×™×¤×”
  
  return text1.includes(text2) || text2.includes(text1);
}



// *** ×‘×“×™×§×” ×× ×˜×§×¡×˜ ××©××¢×•×ª×™ ***
function isSignificantText(text) {
  // ××¡× ×Ÿ ×˜×§×¡×˜×™× ×’× ×¨×™×™× ×•×œ× ××©××¢×•×ª×™×™×
  
  // ×˜×§×¡×˜×™× ×§×¦×¨×™× ××“×™
  if (text.length < 4) return false;
  
  // ×˜×§×¡×˜×™× ×’× ×¨×™×™× × ×¤×•×¦×™×
  const genericTexts = [
    'drawing', 'dwg', 'sheet', 'scale', 'date', 'revision',
    'material', 'qty', 'quantity', 'notes', 'title', 'project',
    '×—×•××¨', '×›××•×ª', '×ª××¨×™×š', '×§× ×” ××™×“×”', '×”×¢×¨×•×ª', '×¤×¨×•×™×™×§×˜',
    'name', 'number', 'size', 'length', 'width', 'height',
    'mm', 'cm', 'inch', '×"×', '×¡"×', '××˜×¨'
  ];
  
  if (genericTexts.some(generic => text.includes(generic))) {
    return false;
  }
  
  // ×¨×§ ×¨×•×•×—×™× ××• ××¡×¤×¨×™×
  if (/^[\s\d\.\-\/]+$/.test(text)) return false;
  
  // ×¨×§ ××•×ª×™×•×ª ×‘×•×“×“×•×ª ××• ×¡×™×× ×™×
  if (/^[a-z\u0590-\u05ff]{1,2}$/.test(text)) return false;
  
  // ××™×œ×™× ×™×—×™×“×•×ª × ×¤×•×¦×•×ª
  const commonWords = [
    'the', 'and', 'or', 'of', 'to', 'for', 'in', 'on', 'at',
    '×¢×œ', '×©×œ', '××ª', '×¢×', '××•', '×•×’×', '×›×œ', '×–×”', '×–×•'
  ];
  
  if (commonWords.includes(text)) return false;
  
  return true;
}

// *** ×—×™×©×•×‘ ×“××™×•×Ÿ ×‘×™×Ÿ ×§×‘×¦×™× ***
function calculateTextSimilarity(file1Data, file2Data) {
  const sig1 = file1Data.significantTexts;
  const sig2 = file2Data.significantTexts;
  
  // ×× ××™×Ÿ ××¡×¤×™×§ ×˜×§×¡×˜×™× ××©××¢×•×ª×™×™×
  if (sig1.length < 5 || sig2.length < 5) {
    return 0;
  }
  
  // ×—×™×©×•×‘ ×—×¤×™×¤×”
  let commonSignificant = 0;
  let totalChecked = 0;
  
  sig1.forEach(function(text1) {
    totalChecked++;
    if (sig2.includes(text1)) {
      commonSignificant++;
    } else {
      // ×‘×“×™×§×ª ×“××™×•×Ÿ ×—×œ×§×™
      sig2.forEach(function(text2) {
        if (isPartialMatch(text1, text2)) {
          commonSignificant += 0.7; // × ×§×•×“×•×ª ×—×œ×§×™×•×ª
        }
      });
    }
  });
  
  // ×—×™×©×•×‘ ××—×•×– ×”×“××™×•×Ÿ
  const similarity = commonSignificant / Math.max(sig1.length, sig2.length);
  
  return Math.min(similarity, 1.0); // ××•×’×‘×œ ×œ-100%
}

// *** ×‘×“×™×§×ª ×”×ª×××” ×—×œ×§×™×ª ***
function isPartialMatch(text1, text2) {
  if (text1.length < 5 || text2.length < 5) return false;
  
  // ×× ××—×“ ××›×™×œ ××ª ×”×©× ×™ (×œ×¤×—×•×ª 70% ××”×˜×§×¡×˜)
  const minLength = Math.min(text1.length, text2.length);
  const maxLength = Math.max(text1.length, text2.length);
  
  if (minLength / maxLength < 0.7) return false;
  
  return text1.includes(text2) || text2.includes(text1);
}

// *** ×—×™×¤×•×© ×˜×§×¡×˜×™× ××ª×§×“× ×¢× ×–×™×”×•×™ ×¨×¦×¤×™× ***
function searchTexts() {
  const searchInput = document.getElementById('simpleSearchInput');
  const searchTerm = searchInput.value.trim();
  
  if (!searchTerm) {
    showSimpleToast('×”×›× ×¡ ×˜×§×¡×˜ ×œ×—×™×¤×•×©');
    searchInput.focus();
    return;
  }
  
  if (extractedTexts.length === 0) {
    showSimpleToast('×”×¨×¥ ×©×œ×™×¤×ª ×˜×§×¡×˜×™× ×ª×—×™×œ×”');
    return;
  }
  
  searchResults = [];
  isSimpleSearchMode = true;
  isSimpleDuplicateMode = false;
  
  // ×—×™×¤×•×© ××ª×§×“× - ×ª×•××š ×‘×¨×¦×¤×™ ××™×œ×™×
  const foundFileIndexes = new Set();
  const searchResults_detailed = [];
  
  if (searchTerm.includes(' ')) {
    // ×—×™×¤×•×© ×¨×¦×£ ××™×œ×™× ×¦××•×“
    searchSequence(searchTerm, foundFileIndexes, searchResults_detailed);
  } else {
    // ×—×™×¤×•×© ××™×œ×” ×™×—×™×“×”
    searchSingleWord(searchTerm, foundFileIndexes, searchResults_detailed);
  }
  
  searchResults = Array.from(foundFileIndexes);
  
  // ×¢×“×›×•×Ÿ ×‘×—×™×¨×” ×•×˜×‘×œ×”
  updateSimpleSelection(searchResults);
  setActiveSimpleButton('simpleSearchBtn');
  
  // ×”×•×“×¢×” ××¤×•×¨×˜×ª
  if (searchResults.length > 0) {
    const matchCount = searchResults_detailed.length;
    showSimpleToast(`× ××¦××• ${matchCount} ×”×ª×××•×ª ×‘-${searchResults.length} ×§×‘×¦×™×`);
    console.log('×¤×™×¨×•×˜ ×ª×•×¦××•×ª ×—×™×¤×•×©:', searchResults_detailed);
  } else {
    showSimpleToast(`×œ× × ××¦××• ×§×‘×¦×™× ×¢× "${searchTerm}"`);
  }
}

// *** ×—×™×¤×•×© ×¨×¦×£ ××™×œ×™× ×¦××•×“ ***
function searchSequence(searchTerm, foundFileIndexes, searchResults_detailed) {
  const searchWords = searchTerm.toLowerCase().trim().split(/\s+/);
  const sequenceLength = searchWords.length;
  
  // ×§×™×‘×•×¥ ×˜×§×¡×˜×™× ×œ×¤×™ ×§×•×‘×¥ ×•×¢××•×“ ×œ××¦×™××ª ×¨×¦×¤×™×
  const filePageMap = {};
  
  extractedTexts.forEach(function(textItem) {
    const key = `${textItem.fileIndex}_${textItem.page}`;
    if (!filePageMap[key]) {
      filePageMap[key] = {
        fileIndex: textItem.fileIndex,
        fileName: textItem.fileName,
        page: textItem.page,
        texts: []
      };
    }
    filePageMap[key].texts.push({
      text: textItem.text.toLowerCase(),
      x: textItem.x,
      y: textItem.y,
      original: textItem.text
    });
  });
  
  // ×—×™×¤×•×© ×¨×¦×¤×™× ×‘×›×œ ×¢××•×“
  Object.values(filePageMap).forEach(function(pageData) {
    // ××™×•×Ÿ ×œ×¤×™ ××™×§×•× (××œ××¢×œ×” ×œ××˜×”, ×•××©×××œ ×œ×™××™×Ÿ)
    pageData.texts.sort(function(a, b) {
      if (Math.abs(a.y - b.y) < 10) { // ××•×ª×” ×©×•×¨×” ×‘×¢×¨×š
        return a.x - b.x; // ××™×•×Ÿ ×œ×¤×™ X
      }
      return b.y - a.y; // ××™×•×Ÿ ×œ×¤×™ Y (××œ××¢×œ×” ×œ××˜×”)
    });
    
    // ×—×™×¤×•×© ×¨×¦×£ ×‘××§×˜×¢×™×
    for (let i = 0; i <= pageData.texts.length - sequenceLength; i++) {
      const segment = pageData.texts.slice(i, i + sequenceLength);
      
      // ×‘×“×™×§×” ×× ×”×¨×¦×£ ×§×¨×•×‘ ××¡×¤×™×§ ××‘×—×™× ×ª ××™×§×•×
      if (isCloseSequence(segment)) {
        const segmentWords = segment.map(t => t.text.trim()).filter(t => t);
        
        // ×‘×“×™×§×” ×× ××ª××™× ×œ×—×™×¤×•×©
        if (matchesSearchSequence(segmentWords, searchWords)) {
          foundFileIndexes.add(pageData.fileIndex);
          searchResults_detailed.push({
            fileName: pageData.fileName,
            page: pageData.page,
            foundText: segment.map(t => t.original).join(' '),
            searchTerm: searchTerm,
            position: { x: segment[0].x, y: segment[0].y }
          });
          break; // × ××¦× ×‘×¨×¦×£ ×”×–×”, ×¢×‘×•×¨ ×œ×¨×¦×£ ×”×‘×
        }
      }
    }
  });
}

// *** ×‘×“×™×§×” ×× ×˜×§×¡×˜×™× ×§×¨×•×‘×™× ×–×” ×œ×–×” ***
function isCloseSequence(segment) {
  if (segment.length < 2) return true;
  
  for (let i = 1; i < segment.length; i++) {
    const prev = segment[i-1];
    const curr = segment[i];
    
    // ×”××¨×—×§ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×’×“×•×œ ××“×™
    const distance = Math.sqrt(Math.pow(curr.x - prev.x, 2) + Math.pow(curr.y - prev.y, 2));
    
    if (distance > 200) { // 200 ×¤×™×§×¡×œ×™× ××§×¡×™××•×
      return false;
    }
  }
  
  return true;
}

// *** ×‘×“×™×§×” ×× ×¨×¦×£ ××ª××™× ×œ×—×™×¤×•×© ***
function matchesSearchSequence(segmentWords, searchWords) {
  if (segmentWords.length !== searchWords.length) return false;
  
  for (let i = 0; i < searchWords.length; i++) {
    if (!segmentWords[i].includes(searchWords[i])) {
      return false;
    }
  }
  
  return true;
}

// *** ×—×™×¤×•×© ××™×œ×” ×™×—×™×“×” ***
function searchSingleWord(searchTerm, foundFileIndexes, searchResults_detailed) {
  const searchLower = searchTerm.toLowerCase();
  
  extractedTexts.forEach(function(textItem) {
    if (textItem.text.toLowerCase().includes(searchLower)) {
      foundFileIndexes.add(textItem.fileIndex);
      
      // ×”×•×¡×£ ×œ×ª×•×¦××•×ª ××¤×•×¨×˜×•×ª ×× ×¢×•×“ ×œ× ×§×™×™×
      const existing = searchResults_detailed.find(r => 
        r.fileName === textItem.fileName && 
        r.page === textItem.page &&
        r.foundText === textItem.text
      );
      
      if (!existing) {
        searchResults_detailed.push({
          fileName: textItem.fileName,
          page: textItem.page,
          foundText: textItem.text,
          searchTerm: searchTerm,
          position: { x: textItem.x, y: textItem.y }
        });
      }
    }
  });
}

// *** ×¢×“×›×•×Ÿ ×‘×—×™×¨×” ×•×¡×™××•×Ÿ ***
function updateSimpleSelection(resultIndexes) {
  // × ×™×§×•×™ ×‘×—×™×¨×•×ª ×§×•×“××•×ª
  if (typeof window.clearAllSelections === 'function') {
    window.clearAllSelections();
  }
  
  // ×¢×“×›×•×Ÿ ×‘×—×™×¨×”
  if (typeof window.selectedRows !== 'undefined') {
    window.selectedRows = resultIndexes.slice();
  }
  
  // ×¢×“×›×•×Ÿ ××•× ×”
  updateSimpleCounter(resultIndexes.length);
  
  // ×¢×“×›×•×Ÿ ×˜×‘×œ×”
  if (typeof window.renderTable === 'function') {
    window.renderTable();
  }
  
  if (typeof window.updateSearchInfo === 'function') {
    window.updateSearchInfo();
  }
}

// *** × ×™×§×•×™ ×›×œ ×”×¡×™× ×•× ×™× ***
function clearSimpleFilters() {
  searchResults = [];
  duplicateResults = [];
  isSimpleSearchMode = false;
  isSimpleDuplicateMode = false;
  isClassificationMode = false;
  currentClassificationMode = null;
  
  // × ×™×§×•×™ ×©×“×” ×—×™×¤×•×©
  const searchInput = document.getElementById('simpleSearchInput');
  if (searchInput) {
    searchInput.value = '';
  }
  
  // × ×™×§×•×™ ×‘×—×™×¨×•×ª
  if (typeof window.clearAllSelections === 'function') {
    window.clearAllSelections();
  }
  
  // × ×™×§×•×™ ×›×¤×ª×•×¨×™× ×¤×¢×™×œ×™×
  clearActiveSimpleButtons();
  
  // ×¢×“×›×•×Ÿ ××•× ×”
  updateSimpleCounter(0);
  
  // ×¢×“×›×•×Ÿ ×˜×‘×œ×”
  if (typeof window.renderTable === 'function') {
    window.renderTable();
  }
  
  showSimpleToast('×›×œ ×”×¡×™× ×•× ×™× ×•×”×¡×™×•×•×’×™× × ×•×§×•');
}

// *** ×¢×“×›×•×Ÿ ××•× ×” ×ª×•×¦××•×ª ***
function updateSimpleCounter(count) {
  const counter = document.getElementById('simpleResultsCount');
  if (counter) {
    counter.textContent = count.toString();
    
    // ×¦×‘×™×¢×” ×œ×¤×™ ×›××•×ª
    if (count > 0) {
      counter.style.color = '#28a745';
      counter.style.fontWeight = 'bold';
    } else {
      counter.style.color = '#6c757d';
      counter.style.fontWeight = 'normal';
    }
  }
}

// *** × ×™×”×•×œ ×›×¤×ª×•×¨×™× ×¤×¢×™×œ×™× ***
function setActiveSimpleButton(buttonId) {
  clearActiveSimpleButtons();
  const button = document.getElementById(buttonId);
  if (button) {
    button.classList.add('simple-active');
  }
}

function clearActiveSimpleButtons() {
  const buttons = document.querySelectorAll('.simple-feature');
  buttons.forEach(function(btn) {
    btn.classList.remove('simple-active');
  });
}

// *** ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ***
function showSimpleToast(message, duration = 3000) {
  if (typeof window.showToast === 'function') {
    window.showToast('ğŸ”§ ' + message, duration);
  } else {
    console.log('Simple Toast:', message);
  }
}

// *** ×¡×˜×™×™×œ×™× ×¤×©×•×˜×™× ***
function addSimpleStyles() {
  if (document.getElementById('simpleStyles')) return;
  
  const style = document.createElement('style');
  style.id = 'simpleStyles';
  style.textContent = `
    .simple-feature {
      background: linear-gradient(135deg, #17a2b8, #138496) !important;
      color: white !important;
      border: none !important;
      transition: all 0.2s ease !important;
    }
    
    .simple-feature:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3) !important;
    }
    
    .simple-active {
      background: linear-gradient(135deg, #28a745, #20c997) !important;
      box-shadow: 0 0 10px rgba(40, 167, 69, 0.5) !important;
    }
    
    .simple-clear {
      background: linear-gradient(135deg, #6c757d, #545b62) !important;
      color: white !important;
      border: none !important;
    }
    
    .simple-clear:hover {
      background: linear-gradient(135deg, #5a6268, #495057) !important;
    }
    
    .simple-counter {
      background: #f8f9fa !important;
      border: 2px solid #dee2e6 !important;
      border-radius: 4px !important;
      padding: 8px 12px !important;
      text-align: center !important;
      min-width: 80px !important;
    }
    
    .simple-counter .counter-label {
      font-size: 11px !important;
      color: #6c757d !important;
      margin-bottom: 2px !important;
    }
    
    .simple-counter .counter-value {
      font-size: 18px !important;
      font-weight: bold !important;
      color: #495057 !important;
    }
    
    /* ×”×“×’×©×ª ×©×•×¨×•×ª ×©× ××¦××• */
    .table-container tr.selected {
      background-color: #d1ecf1 !important;
      border-left: 4px solid #17a2b8 !important;
    }
    
    /* ×× ×™××¦×™×” ×œ×›×¤×ª×•×¨×™× ×¤×¢×™×œ×™× */
    .simple-active::after {
      content: 'âœ“';
      position: absolute;
      top: 2px;
      right: 4px;
      font-size: 12px;
      color: white;
      font-weight: bold;
    }
    
    /* ×›×¤×ª×•×¨ ×¡×™×•×•×’×™× */
    .classification-feature {
      background: linear-gradient(135deg, #fd7e14, #e8590c) !important;
      color: white !important;
      border: none !important;
      transition: all 0.2s ease !important;
    }
    
    .classification-feature:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(253, 126, 20, 0.3) !important;
    }
  `;
  
  document.head.appendChild(style);
}

// *** ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ×¡×™×•×•×’×™× ***

function showClassificationPopup() {
  // ×™×¦×™×¨×ª ×—×œ×•×Ÿ ×”×’×“×¨×•×ª ×¡×™×•×•×’
  let popup = document.getElementById('classificationPopup');
  if (popup) {
    popup.remove();
  }
  
  popup = document.createElement('div');
  popup.id = 'classificationPopup';
  popup.className = 'popup-overlay';
  popup.style.display = 'block';
  
  popup.innerHTML = `
    <div class="popup-window" style="max-width: 600px;">
      <div class="popup-header">
        <div class="popup-title">ğŸ·ï¸ × ×™×”×•×œ ×¡×™×•×•×’×™×</div>
        <button class="popup-close" onclick="closeClassificationPopup()">&times;</button>
      </div>
      <div class="popup-body">
        <div style="margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">×”×•×¡×£ ×¡×™×•×•×’ ×—×“×©:</h4>
          <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <input type="text" id="newClassificationName" placeholder="×©× ×”×¡×™×•×•×’ (×œ×“×•×’××”: ×—×•××¨×™ ××ª×›×ª)"
                   style="flex: 2; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
            <input type="text" id="newClassificationTerms" placeholder="××™×œ×•×ª ×—×™×¤×•×© (×œ×“×•×’××”: ××œ×•××™× ×™×•×,×¤×œ×“×”,×‘×¨×–×œ)"
                   style="flex: 3; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="addClassification()" class="popup-btn" style="background: #28a745;">×”×•×¡×£</button>
          </div>
          <small style="color: #666;">×”×¤×¨×“ ××™×œ×•×ª ×—×™×¤×•×© ×‘×¤×¡×™×§×™×. ×”×¡×™×•×•×’ ×™×—×¤×© ×§×‘×¦×™× ×”××›×™×œ×™× ××—×ª ××• ×™×•×ª×¨ ××”××™×œ×™×.</small>
        </div>
        
        <div style="border-top: 1px solid #ddd; padding-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">×¡×™×•×•×’×™× ×§×™×™××™×:</h4>
          <div id="classificationList" style="max-height: 200px; overflow-y: auto;">
            <!-- ×¨×©×™××ª ×¡×™×•×•×’×™× ×ª×•×¦×’ ×›××Ÿ -->
          </div>
        </div>
        
        <div style="border-top: 1px solid #ddd; padding-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">×”×—×œ ×¡×™×•×•×’:</h4>
          <div id="applyClassificationList">
            <!-- ×›×¤×ª×•×¨×™ ×¡×™×•×•×’ ×™×•×¦×’×• ×›××Ÿ -->
          </div>
        </div>
        
        <div style="border-top: 1px solid #ddd; padding-top: 15px;">
          <button onclick="addClassificationColumnManually()" class="popup-btn" 
                  style="background: #17a2b8; color: white; width: 100%; padding: 8px;">
            â• ×”×•×¡×£ ×¢××•×“×ª ×¡×™×•×•×’ ×œ×˜×‘×œ×”
          </button>
          <small style="color: #666; display: block; margin-top: 5px;">
            ×œ×—×¥ ×× ×¢××•×“×ª ×”×¡×™×•×•×’ ×œ× ××•×¤×™×¢×” ×‘×˜×‘×œ×”
          </small>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // ×˜×¢×™× ×ª ×”×¡×™×•×•×’×™× ×”×§×™×™××™×
  loadClassificationSettings();
  updateClassificationDisplay();
}

function closeClassificationPopup() {
  const popup = document.getElementById('classificationPopup');
  if (popup) {
    popup.remove();
  }
}

function addClassification() {
  const nameInput = document.getElementById('newClassificationName');
  const termsInput = document.getElementById('newClassificationTerms');
  
  const name = nameInput.value.trim();
  const terms = termsInput.value.trim();
  
  if (!name || !terms) {
    showSimpleToast('×× × ××œ× ××ª ×©× ×”×¡×™×•×•×’ ×•××™×œ×•×ª ×”×—×™×¤×•×©');
    return;
  }
  
  // ×‘×“×™×§×” ×©×”×¡×™×•×•×’ ×œ× ×§×™×™×
  if (classificationSettings.find(c => c.name === name)) {
    showSimpleToast('×¡×™×•×•×’ ×‘×©× ×–×” ×›×‘×¨ ×§×™×™×');
    return;
  }
  
  // ×”×•×¡×¤×ª ×”×¡×™×•×•×’
  const classification = {
    name: name,
    terms: terms.split(',').map(t => t.trim().toLowerCase()).filter(t => t),
    id: 'class_' + Date.now()
  };
  
  classificationSettings.push(classification);
  saveClassificationSettings();
  
  // × ×™×§×•×™ ×”×©×“×•×ª
  nameInput.value = '';
  termsInput.value = '';
  
  updateClassificationDisplay();
  showSimpleToast(`×¡×™×•×•×’ "${name}" × ×•×¡×£ ×‘×”×¦×œ×—×”`);
}

function deleteClassification(classificationId) {
  if (confirm('×”×× ×œ××—×•×§ ××ª ×”×¡×™×•×•×’ ×”×–×”?')) {
    classificationSettings = classificationSettings.filter(c => c.id !== classificationId);
    saveClassificationSettings();
    updateClassificationDisplay();
    showSimpleToast('×¡×™×•×•×’ × ××—×§');
  }
}

function updateClassificationDisplay() {
  const listContainer = document.getElementById('classificationList');
  const applyContainer = document.getElementById('applyClassificationList');
  
  if (!listContainer || !applyContainer) return;
  
  // ×¨×©×™××ª ×¡×™×•×•×’×™× ×§×™×™××™×
  if (classificationSettings.length === 0) {
    listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">××™×Ÿ ×¡×™×•×•×’×™×</div>';
  } else {
    listContainer.innerHTML = classificationSettings.map(c => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 4px;">
        <div>
          <strong>${c.name}</strong><br>
          <small style="color: #666;">××™×œ×•×ª ×—×™×¤×•×©: ${c.terms.join(', ')}</small>
        </div>
        <button onclick="deleteClassification('${c.id}')" class="popup-btn" style="background: #dc3545;">××—×§</button>
      </div>
    `).join('');
  }
  
  // ×›×¤×ª×•×¨×™ ×”×—×œ×ª ×¡×™×•×•×’
  if (classificationSettings.length === 0) {
    applyContainer.innerHTML = '<div style="text-align: center; color: #999;">×”×•×¡×£ ×¡×™×•×•×’×™× ×›×“×™ ×œ×”×©×ª××© ×‘×”×</div>';
  } else {
    applyContainer.innerHTML = classificationSettings.map(c => `
      <button onclick="applyClassification('${c.id}')" class="popup-btn" style="margin: 3px; background: #fd7e14;">
        ×”×—×œ: ${c.name}
      </button>
    `).join('');
  }
}

function applyClassification(classificationId) {
  const classification = classificationSettings.find(c => c.id === classificationId);
  if (!classification) return;
  
  if (extractedTexts.length === 0) {
    showSimpleToast('×”×¨×¥ ×©×œ×™×¤×ª ×˜×§×¡×˜×™× ×ª×—×™×œ×”');
    return;
  }
  
  // ×—×™×¤×•×© ×§×‘×¦×™× ×œ×¤×™ ×”×¡×™×•×•×’
  const foundFileIndexes = new Set();
  
  extractedTexts.forEach(function(textItem) {
    const textLower = textItem.text.toLowerCase();
    
    // ×‘×“×™×§×” ×× ×”×˜×§×¡×˜ ××›×™×œ ××—×ª ×××™×œ×•×ª ×”×—×™×¤×•×©
    const hasMatch = classification.terms.some(term => textLower.includes(term));
    
    if (hasMatch) {
      foundFileIndexes.add(textItem.fileIndex);
    }
  });
  
  searchResults = Array.from(foundFileIndexes);
  isClassificationMode = true;
  currentClassificationMode = classification.name;
  isSimpleSearchMode = false;
  isSimpleDuplicateMode = false;
  
  // ×¡×’×™×¨×ª ×”×—×œ×•×Ÿ
  closeClassificationPopup();
  
  // ×¢×“×›×•×Ÿ ×‘×—×™×¨×” ×•×˜×‘×œ×”
  updateSimpleSelection(searchResults);
  setActiveClassificationButton();
  
  const message = `×¡×™×•×•×’ "${classification.name}": × ××¦××• ${searchResults.length} ×§×‘×¦×™×`;
  showSimpleToast(message);
  
  console.log('ğŸ·ï¸ ×ª×•×¦××•×ª ×¡×™×•×•×’:', {
    classification: classification.name,
    terms: classification.terms,
    filesFound: searchResults.length,
    files: searchResults
  });
}

function setActiveClassificationButton() {
  clearActiveSimpleButtons();
  // ×™×¦×™×¨×ª ××™× ×“×™×§×˜×•×¨ ×—×–×•×ª×™ ×œ×¡×™×•×•×’ ×¤×¢×™×œ
  if (currentClassificationMode) {
    showSimpleToast(`×¡×™×•×•×’ ×¤×¢×™×œ: ${currentClassificationMode}`, 5000);
  }
}

function saveClassificationSettings() {
  try {
    localStorage.setItem('pdfClassificationSettings', JSON.stringify(classificationSettings));
  } catch (e) {
    console.warn('×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ×”×’×“×¨×•×ª ×¡×™×•×•×’:', e);
  }
}

function loadClassificationSettings() {
  try {
    const stored = localStorage.getItem('pdfClassificationSettings');
    if (stored) {
      classificationSettings = JSON.parse(stored);
    }
  } catch (e) {
    console.warn('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×”×’×“×¨×•×ª ×¡×™×•×•×’:', e);
    classificationSettings = [];
  }
}

console.log('âœ… ×ª×•×¡×¤×ª ×¤×©×•×˜×” × ×˜×¢× ×” - ×©×œ×™×¤×” + ×›×¤×™×œ×•×ª + ×—×™×¤×•×© + ×¡×™××•×Ÿ + ×¡×™× ×•×Ÿ');